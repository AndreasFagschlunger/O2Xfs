plugins {
    id 'jvm-component'
    id 'java-lang'
}

apply plugin: 'cpp'
apply plugin: 'visual-studio'

task 'javah-xf3'(type:Exec) {
    commandLine 'javah',
                '-cp',
                "${file('bin')};${file('../at.o2xfs.win32/bin')}",
                '-d',
                file('src/o2xfs-xfs3-test.dll/headers'),
                'at.o2xfs.xfs.cdm.v3_00.CashUnitInfo3Test',
                'at.o2xfs.xfs.cdm.v3_00.CdmCaps3Test',
                'at.o2xfs.xfs.cdm.v3_00.CdmStatus3Test',
                'at.o2xfs.xfs.cdm.v3_00.CurrencyExp3Test',
                'at.o2xfs.xfs.cdm.v3_00.MixTable3Test',
                'at.o2xfs.xfs.cdm.v3_00.MixType3Test',
                'at.o2xfs.xfs.cdm.v3_00.PresentStatus3Test',
                'at.o2xfs.xfs.cdm.v3_00.TellerDetails3Test'
}

task 'javah-xf310'(type:Exec) {
    commandLine 'javah',
                '-cp',
                "${file('bin')};${file('../at.o2xfs.win32/bin')}",
                '-d',
                file('src/o2xfs-xfs310-test.dll/headers'),
                'at.o2xfs.xfs.cdm.v3_10.CashUnit3_10Test',
                'at.o2xfs.xfs.cdm.v3_10.CdmCaps3_10Test',
                'at.o2xfs.xfs.cdm.v3_10.CdmStatus3_10Test'
}

task 'javah-xf320'(type:Exec) {
    commandLine 'javah',
                '-cp',
                "${file('bin')};${file('../at.o2xfs.win32/bin')}",
                '-d',
                file('src/o2xfs-xfs320-test.dll/headers'),
                'at.o2xfs.xfs.cdm.v3_20.CdmCaps3_20Test',
                'at.o2xfs.xfs.cdm.v3_20.CdmStatus3_20Test'
}

task 'javah-xf330'(type:Exec) {
    commandLine 'javah',
                '-cp',
                "${file('bin')};${file('../at.o2xfs.win32/bin')}",
                '-d',
                file('src/o2xfs-xfs330-test.dll/headers'),
                'at.o2xfs.xfs.cdm.v3_30.CdmCaps3_30Test'
}

task javah() {
    tasks.getByName('javah-xf3').execute()
    tasks.getByName('javah-xf310').execute()
    tasks.getByName('javah-xf320').execute()
    tasks.getByName('javah-xf330').execute()
}

model {
    binaries {
        withType(SharedLibraryBinarySpec) {
            if (toolChain in VisualCpp) {
                cCompiler.args "/Zi"
                cCompiler.define "DLL_EXPORT"
            }
        }
    }

    repositories {
        libs(PrebuiltLibraries) {
            jni {
                def javaHome = System.getenv('JAVA_HOME')
                headers.srcDirs "${javaHome}/include", "${javaHome}/include/win32"
            }
            xfs3 {
                headers.srcDir "${XFS_SDK300}/INCLUDE"
            }
            xfs310 {
                headers.srcDir "${XFS_SDK310}/INCLUDE"
            }
            xfs320 {
                headers.srcDir "${XFS_SDK320}/INCLUDE"
            }
            xfs330 {
                headers.srcDir "${XFS_SDK330}/INCLUDE"
            }
        }
    }

    components {
        'o2xfs-xfs3'(JvmLibrarySpec) {
            api {
                dependencies {
                    project ':at.o2xfs.xfs' library 'at.o2xfs.xfs'
                }
            }
        }
        'o2xfs-xfs310'(JvmLibrarySpec) {
            api {
                dependencies {
                    library 'o2xfs-xfs3'
                }
            }
        }
        'o2xfs-xfs320'(JvmLibrarySpec) {
            api {
                dependencies {
                    library 'o2xfs-xfs310'
                }
            }
        }
        'o2xfs-xfs330'(JvmLibrarySpec) {
            api {
                dependencies {
                    library 'o2xfs-xfs320'
                }
            }
        }

        'o2xfs-xfs3-test.dll'(NativeLibrarySpec) {
            binaries.all {
                lib project: ':at.o2xfs.win32', library: 'at.o2xfs.win32.dll'
                lib library: 'jni', linkage: 'api'
                lib library: 'xfs3', linkage: 'api'
            }
        }
        'o2xfs-xfs310-test.dll'(NativeLibrarySpec) {
            binaries.all {
                lib project: ':at.o2xfs.win32', library: 'at.o2xfs.win32.dll'
                lib library: 'jni', linkage: 'api'
                lib library: 'xfs310', linkage: 'api'
            }
        }
        'o2xfs-xfs320-test.dll'(NativeLibrarySpec) {
            binaries.all {
                lib project: ':at.o2xfs.win32', library: 'at.o2xfs.win32.dll'
                lib library: 'jni', linkage: 'api'
                lib library: 'xfs320', linkage: 'api'
            }
        }
        'o2xfs-xfs330-test.dll'(NativeLibrarySpec) {
            binaries.all {
                lib project: ':at.o2xfs.win32', library: 'at.o2xfs.win32.dll'
                lib library: 'jni', linkage: 'api'
                lib library: 'xfs330', linkage: 'api'
            }
        }
    }
}