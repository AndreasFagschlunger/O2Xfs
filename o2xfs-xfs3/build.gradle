apply plugin: 'cpp'
apply plugin: 'visual-studio'

task 'javah-xfs3'(type:Exec) {
    commandLine 'javah',
                '-cp',
                "${file('bin')};${file('../at.o2xfs.win32/bin')}",
                '-d',
                file('src/o2xfs-xfs3-test.dll/headers'),
                'at.o2xfs.xfs.cdm.v3_00.Calibrate3Test',
                'at.o2xfs.xfs.cdm.v3_00.CashUnitError3Test',
                'at.o2xfs.xfs.cdm.v3_00.CashUnitInfo3Test',
                'at.o2xfs.xfs.cdm.v3_00.CdmCaps3Test',
                'at.o2xfs.xfs.cdm.v3_00.CdmStatus3Test',
                'at.o2xfs.xfs.cdm.v3_00.Count3Test',
                'at.o2xfs.xfs.cdm.v3_00.CountsChanged3Test',
                'at.o2xfs.xfs.cdm.v3_00.CurrencyExp3Test',
                'at.o2xfs.xfs.cdm.v3_00.Denominate3Test',
                'at.o2xfs.xfs.cdm.v3_00.Dispense3Test',
                'at.o2xfs.xfs.cdm.v3_00.MixTable3Test',
                'at.o2xfs.xfs.cdm.v3_00.MixType3Test',
                'at.o2xfs.xfs.cdm.v3_00.PresentStatus3Test',
                'at.o2xfs.xfs.cdm.v3_00.StartEx3Test',
                'at.o2xfs.xfs.cdm.v3_00.TellerDetails3Test'
}

task 'javah-xfs3-cim'(type:Exec) {
    commandLine 'javah',
                '-cp',
                "${file('bin')};${file('../at.o2xfs.win32/bin')}",
                '-d',
                file('src/o2xfs-xfs3-test.dll/headers/cim'),                
                'at.o2xfs.xfs.cim.v3_00.Capabilities3Test',
                'at.o2xfs.xfs.cim.v3_00.CashInfo3Test',
                'at.o2xfs.xfs.cim.v3_00.CashInStart3Test',
                'at.o2xfs.xfs.cim.v3_00.CashInStatus3Test',
                'at.o2xfs.xfs.cim.v3_00.CashInType3Test',
                'at.o2xfs.xfs.cim.v3_00.CashUnitError3Test',
                'at.o2xfs.xfs.cim.v3_00.CountsChanged3Test',
                'at.o2xfs.xfs.cim.v3_00.CurrencyExp3Test',
                'at.o2xfs.xfs.cim.v3_00.GetP6Signature3Test',
                'at.o2xfs.xfs.cim.v3_00.ItemPosition3Test',
                'at.o2xfs.xfs.cim.v3_00.NoteTypeList3Test',
                'at.o2xfs.xfs.cim.v3_00.P6Info3Test',
                'at.o2xfs.xfs.cim.v3_00.P6Signature3Test',
                'at.o2xfs.xfs.cim.v3_00.StartEx3Test',
                'at.o2xfs.xfs.cim.v3_00.Status3Test',
                'at.o2xfs.xfs.cim.v3_00.TellerInfo3Test',
                'at.o2xfs.xfs.cim.v3_00.TellerUpdate3Test'
}

task 'javah-xfs310'(type:Exec) {
    commandLine 'javah',
                '-cp',
                "${file('bin')};${file('../at.o2xfs.win32/bin')}",
                '-d',
                file('src/o2xfs-xfs310-test.dll/headers'),
                'at.o2xfs.xfs.cdm.v3_10.CashUnit3_10Test',
                'at.o2xfs.xfs.cdm.v3_10.CashUnitError3_10Test',
                'at.o2xfs.xfs.cdm.v3_10.CdmCaps3_10Test',
                'at.o2xfs.xfs.cdm.v3_10.CdmStatus3_10Test',
                'at.o2xfs.xfs.cdm.v3_10.DevicePosition3_10Test',
                'at.o2xfs.xfs.cdm.v3_10.PowerSaveChange3_10Test',
                'at.o2xfs.xfs.cdm.v3_10.PowerSaveControl3_10Test',
                'at.o2xfs.xfs.cdm.v3_10.PrepareDispense3_10Test',
                'at.o2xfs.xfs.cdm.v3_10.SetGuidLight3_10Test'
}

task 'javah-xfs310-cim'(type:Exec) {
    commandLine 'javah',
                '-cp',
                "${file('bin')};${file('../at.o2xfs.win32/bin')}",
                '-d',
                file('src/o2xfs-xfs310-test.dll/headers/cim'),                
                'at.o2xfs.xfs.cim.v3_10.Capabilities3_10Test',
                'at.o2xfs.xfs.cim.v3_10.CashIn3_10Test',
                'at.o2xfs.xfs.cim.v3_10.ConfigureNoteReader3_10Test',
                'at.o2xfs.xfs.cim.v3_10.ConfigureNoteReaderOut3_10Test',
                'at.o2xfs.xfs.cim.v3_10.DevicePosition3_10Test',
                'at.o2xfs.xfs.cim.v3_10.GetItemInfo3_10Test',
                'at.o2xfs.xfs.cim.v3_10.ItemInfo3_10Test',
                'at.o2xfs.xfs.cim.v3_10.ItemInfoSummary3_10Test',
                'at.o2xfs.xfs.cim.v3_10.P6CompareResult3_10Test',
                'at.o2xfs.xfs.cim.v3_10.P6CompareSignature3_10Test',
                'at.o2xfs.xfs.cim.v3_10.PositionCapabilities3_10Test',
                'at.o2xfs.xfs.cim.v3_10.PositionInfo3_10Test',
                'at.o2xfs.xfs.cim.v3_10.PowerSaveChange3_10Test',
                'at.o2xfs.xfs.cim.v3_10.PowerSaveControl3_10Test',
                'at.o2xfs.xfs.cim.v3_10.SetGuidLight3_10Test',
                'at.o2xfs.xfs.cim.v3_10.Status3_10Test'
}

task 'javah-xfs310-bcr'(type:Exec) {
    commandLine 'javah',
                '-cp',
                "${file('bin')};${file('../at.o2xfs.win32/bin')}",
                '-d',
                file('src/o2xfs-xfs310-test.dll/headers/bcr'),
                'at.o2xfs.xfs.bcr.v3_10.Capabilities3_10Test'
}

task 'javah-xfs320'(type:Exec) {
    commandLine 'javah',
                '-cp',
                "${file('bin')};${file('../at.o2xfs.win32/bin')}",
                '-d',
                file('src/o2xfs-xfs320-test.dll/headers'),
                'at.o2xfs.xfs.cdm.v3_20.CdmCaps3_20Test',
                'at.o2xfs.xfs.cdm.v3_20.CdmStatus3_20Test',
                'at.o2xfs.xfs.cdm.v3_20.ItemNumberList3_20Test'
}

task 'javah-xfs320-cim'(type:Exec) {
    commandLine 'javah',
                '-cp',
                "${file('bin')};${file('../at.o2xfs.win32/bin')}",
                '-d',
                file('src/o2xfs-xfs320-test.dll/headers/cim'),
                'at.o2xfs.xfs.cim.v3_20.Capabilities3_20Test',
                'at.o2xfs.xfs.cim.v3_20.CashCapabilities3_20Test',
                'at.o2xfs.xfs.cim.v3_20.CashInLimit3_20Test',
                'at.o2xfs.xfs.cim.v3_20.Count3_20Test',
                'at.o2xfs.xfs.cim.v3_20.DeviceLockControl3_20Test',
                'at.o2xfs.xfs.cim.v3_20.DeviceLockStatus3_20Test',
                'at.o2xfs.xfs.cim.v3_20.IncompleteReplenish3_20Test',
                'at.o2xfs.xfs.cim.v3_20.PositionCapability3_20Test',
                'at.o2xfs.xfs.cim.v3_20.Present3_20Test',
                'at.o2xfs.xfs.cim.v3_20.Replenish3_20Test',
                'at.o2xfs.xfs.cim.v3_20.ReplenishInfo3_20Test',
                'at.o2xfs.xfs.cim.v3_20.ReplenishInfoResult3_20Test',
                'at.o2xfs.xfs.cim.v3_20.ReplenishResult3_20Test',
                'at.o2xfs.xfs.cim.v3_20.SetMode3_20Test',
                'at.o2xfs.xfs.cim.v3_20.Status3_20Test'
}

task 'javah-xfs330'(type:Exec) {
    commandLine 'javah',
                '-cp',
                "${file('bin')};${file('../at.o2xfs.win32/bin')}",
                '-d',
                file('src/o2xfs-xfs330-test.dll/headers'),
                'at.o2xfs.xfs.cdm.v3_30.AllItemsInfo3_30Test',
                'at.o2xfs.xfs.cdm.v3_30.Blacklist3_30Test',
                'at.o2xfs.xfs.cdm.v3_30.CdmCaps3_30Test',
                'at.o2xfs.xfs.cdm.v3_30.GetAllItemsInfo3_30Test',
                'at.o2xfs.xfs.cdm.v3_30.GetItemInfo3_30Test',
                'at.o2xfs.xfs.cdm.v3_30.IncompleteRetract3_30Test',
                'at.o2xfs.xfs.cdm.v3_30.ItemInfo3_30Test',
                'at.o2xfs.xfs.cdm.v3_30.ItemInfoSummary3_30Test',
                'at.o2xfs.xfs.cdm.v3_30.ShutterStatusChanged3_30Test',
                'at.o2xfs.xfs.cdm.v3_30.SynchronizeCommand3_30Test'
}

task 'javah-xfs330-cim'(type:Exec) {
    commandLine 'javah',
                '-cp',
                "${file('bin')};${file('../at.o2xfs.win32/bin')}",
                '-d',
                file('src/o2xfs-xfs330-test.dll/headers/cim'),
                'at.o2xfs.xfs.cim.v3_30.AllItemsInfo3_30Test',
                'at.o2xfs.xfs.cim.v3_30.Blacklist3_30Test',
                'at.o2xfs.xfs.cim.v3_30.Capabilities3_30Test',
                'at.o2xfs.xfs.cim.v3_30.Deplete3_30Test',
                'at.o2xfs.xfs.cim.v3_30.DepleteInfo3_30Test',
                'at.o2xfs.xfs.cim.v3_30.DepleteInfoResult3_30Test',
                'at.o2xfs.xfs.cim.v3_30.DepleteResult3_30Test',
                'at.o2xfs.xfs.cim.v3_30.GetAllItemsInfo3_30Test',
                'at.o2xfs.xfs.cim.v3_30.IncompleteDeplete3_30Test',
                'at.o2xfs.xfs.cim.v3_30.Inpos3_30Test',
                'at.o2xfs.xfs.cim.v3_30.ItemInfo3_30Test',
                'at.o2xfs.xfs.cim.v3_30.ShutterStatusChanged3_30Test',
                'at.o2xfs.xfs.cim.v3_30.SynchronizeCommand3_30Test'
}

task javah() << {
    tasks.getByName('javah-xf3').execute()
    tasks.getByName('javah-xf3-cim').execute()
    tasks.getByName('javah-xfs310').execute()
    tasks.getByName('javah-xfs310-cim').execute()
    tasks.getByName('javah-xfs320').execute()
    tasks.getByName('javah-xfs320-cim').execute()
    tasks.getByName('javah-xfs330').execute()
    tasks.getByName('javah-xfs330-cim').execute()
}

sourceSets {
    main {
        java {
            srcDir 'src/o2xfs-xfs3/java'
        }
        java {
            srcDir 'src/o2xfs-xfs310/java'
        }
        java {
            srcDir 'src/o2xfs-xfs320/java'
        }
        java {
            srcDir 'src/o2xfs-xfs330/java'
        }
    }
}

dependencies {
    compile project(':at.o2xfs.xfs')
    testCompile libraries.junit
    releaseDll project(path: ':at.o2xfs.xfs', configuration: 'releaseDll')
}

test {
    systemProperty 'java.library.path', configurations.releaseDll.collect { it.parentFile.absolutePath }.join(';') + ';' + file('build/libs/o2xfs-xfs3-test.dll/shared').absolutePath + ';' + file('build/libs/o2xfs-xfs310-test.dll/shared').absolutePath + ';' + file('build/libs/o2xfs-xfs320-test.dll/shared').absolutePath + ';' + file('build/libs/o2xfs-xfs330-test.dll/shared').absolutePath
}

model {
    binaries {
        withType(SharedLibraryBinarySpec) {
            if (toolChain in VisualCpp) {
                cCompiler.args "/Zi"
                cCompiler.define "DLL_EXPORT"
            }
        }
    }

    repositories {
        libs(PrebuiltLibraries) {
            jni {
                def javaHome = System.getenv('JAVA_HOME')
                if(project.hasProperty('org.gradle.java.home')) {
                    javaHome = project.getProperty('org.gradle.java.home');
                }
                headers.srcDirs "${javaHome}/include", "${javaHome}/include/win32"
            }
            xfs3 {
                headers.srcDir "${XFS_SDK300}/INCLUDE"
            }
            xfs310 {
                headers.srcDir "${XFS_SDK310}/INCLUDE"
            }
            xfs320 {
                headers.srcDir "${XFS_SDK320}/INCLUDE"
            }
            xfs330 {
                headers.srcDir "${XFS_SDK330}/INCLUDE"
            }
        }
    }

    components {
        'o2xfs-xfs3-test.dll'(NativeLibrarySpec) {
            binaries.all {
                lib project: ':at.o2xfs.win32', library: 'at.o2xfs.win32.dll'
                lib library: 'jni', linkage: 'api'
                lib library: 'xfs3', linkage: 'api'
            }
        }
        'o2xfs-xfs310-test.dll'(NativeLibrarySpec) {
            binaries.all {
                lib project: ':at.o2xfs.win32', library: 'at.o2xfs.win32.dll'
                lib library: 'jni', linkage: 'api'
                lib library: 'xfs310', linkage: 'api'
            }
        }
        'o2xfs-xfs320-test.dll'(NativeLibrarySpec) {
            binaries.all {
                lib project: ':at.o2xfs.win32', library: 'at.o2xfs.win32.dll'
                lib library: 'jni', linkage: 'api'
                lib library: 'xfs320', linkage: 'api'
            }
        }
        'o2xfs-xfs330-test.dll'(NativeLibrarySpec) {
            binaries.all {
                lib project: ':at.o2xfs.win32', library: 'at.o2xfs.win32.dll'
                lib library: 'jni', linkage: 'api'
                lib library: 'xfs330', linkage: 'api'
            }
        }
    }
}

publishing {
    publications {
        mavenJava(MavenPublication) {
            groupId 'at.o2xfs'
            artifactId 'o2xfs-xfs3'
            version version

            from components.java

            artifact(file('build/libs/o2xfs-xfs3-test.dll/shared/o2xfs-xfs3-test.dll')) {
            }
            artifact(file('build/libs/o2xfs-xfs3-test.dll/shared/o2xfs-xfs3-test.exp')) {
            }
            artifact(file('build/libs/o2xfs-xfs3-test.dll/shared/o2xfs-xfs3-test.lib')) {
            }
            
            artifact(file('build/libs/o2xfs-xfs310-test.dll/shared/o2xfs-xfs310-test.dll')) {
            	classifier 'xfs310'
            }
            artifact(file('build/libs/o2xfs-xfs310-test.dll/shared/o2xfs-xfs310-test.exp')) {
            	classifier 'xfs310'
            }
            artifact(file('build/libs/o2xfs-xfs310-test.dll/shared/o2xfs-xfs310-test.lib')) {
            	classifier 'xfs310'
            }

            artifact(file('build/libs/o2xfs-xfs320-test.dll/shared/o2xfs-xfs320-test.dll')) {
            	classifier 'xfs320'
            }
            artifact(file('build/libs/o2xfs-xfs320-test.dll/shared/o2xfs-xfs320-test.exp')) {
            	classifier 'xfs320'
            }
            artifact(file('build/libs/o2xfs-xfs320-test.dll/shared/o2xfs-xfs320-test.lib')) {
            	classifier 'xfs320'
            }

            artifact(file('build/libs/o2xfs-xfs330-test.dll/shared/o2xfs-xfs330-test.dll')) {
            	classifier 'xfs330'
            }
            artifact(file('build/libs/o2xfs-xfs330-test.dll/shared/o2xfs-xfs330-test.exp')) {
            	classifier 'xfs330'
            }
            artifact(file('build/libs/o2xfs-xfs330-test.dll/shared/o2xfs-xfs330-test.lib')) {
            	classifier 'xfs330'
            }

            artifact sourcesJar {
                classifier 'sources'
            }

            artifact javadocJar {
                classifier 'javadoc'
            }            
        }
    }
}

// create the javadoc jar
task javadocJar(type: Jar, dependsOn: javadoc) {
    from javadoc.destinationDir
    classifier = 'javadoc'
}

// create the sources jar
task sourcesJar(type: Jar, dependsOn: compileJava) {
    from sourceSets.main.allSource
    classifier = 'sources'
}